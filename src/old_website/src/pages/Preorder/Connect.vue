<template>
  <div class="flex flex-col md:grid grid-cols-3 grid-rows-1 flex-1 items-center justify-center gap-8">
    <div class="flex flex-col items-center justify-center gap-y-8 mt-12">
      <div class="w-1/3">
        <svg viewBox="0 0 24 24" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
          <!-- Uploaded to SVGRepo https://www.svgrepo.com -->
          <title>ic_fluent_team_add_24_regular</title>
          <desc>Created with Sketch.</desc>
          <g id="🔍-Product-Icons" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
            <g id="ic_fluent_team_add_24_regular" fill="#212121" fill-rule="nonzero">
              <path
                d="M17.5,12 C20.5375661,12 23,14.4624339 23,17.5 C23,20.5375661 20.5375661,23 17.5,23 C14.4624339,23 12,20.5375661 12,17.5 C12,14.4624339 14.4624339,12 17.5,12 Z M17.5,13.9992349 L17.4101244,14.0072906 C17.2060313,14.0443345 17.0450996,14.2052662 17.0080557,14.4093593 L17,14.4992349 L16.9996498,16.9992349 L14.4976498,17 L14.4077742,17.0080557 C14.2036811,17.0450996 14.0427494,17.2060313 14.0057055,17.4101244 L13.9976498,17.5 L14.0057055,17.5898756 C14.0427494,17.7939687 14.2036811,17.9549004 14.4077742,17.9919443 L14.4976498,18 L17.0006498,17.9992349 L17.0011076,20.5034847 L17.0091633,20.5933603 C17.0462073,20.7974534 17.207139,20.9583851 17.411232,20.995429 L17.5011076,21.0034847 L17.5909833,20.995429 C17.7950763,20.9583851 17.956008,20.7974534 17.993052,20.5933603 L18.0011076,20.5034847 L18.0006498,17.9992349 L20.5045655,18 L20.5944411,17.9919443 C20.7985342,17.9549004 20.9594659,17.7939687 20.9965098,17.5898756 L21.0045655,17.5 L20.9965098,17.4101244 C20.9594659,17.2060313 20.7985342,17.0450996 20.5944411,17.0080557 L20.5045655,17 L17.9996498,16.9992349 L18,14.4992349 L17.9919443,14.4093593 C17.9549004,14.2052662 17.7939687,14.0443345 17.5898756,14.0072906 L17.5,13.9992349 Z M14.2540247,10 C15.0885672,10 15.8169906,10.4543496 16.2054276,11.1291814 C15.6719841,11.2368176 15.1631195,11.409593 14.6865144,11.6387884 C14.5648628,11.550964 14.4153954,11.5 14.2540247,11.5 L9.75192738,11.5 C9.33771382,11.5 9.00192738,11.8357864 9.00192738,12.25 L9.00192738,16.4989513 C9.00192738,17.9098632 9.97557657,19.0933671 11.2876273,19.4142154 C11.4604353,19.9797789 11.7097452,20.5127963 12.0225923,21.0012092 L12.002976,21 C9.51711551,21 7.50192738,18.9848119 7.50192738,16.4989513 L7.50192738,12.25 C7.50192738,11.0073593 8.5092867,10 9.75192738,10 L14.2540247,10 Z M7.40645343,10.000271 C7.01177565,10.4116389 6.72426829,10.9266236 6.58881197,11.5003444 L4.25,11.5 C3.83578644,11.5 3.5,11.8357864 3.5,12.25 L3.5,14.99876 C3.5,16.3801567 4.61984327,17.5 6.00123996,17.5 C6.20123055,17.5 6.39573909,17.4765286 6.58216119,17.4321901 C6.66686857,17.9361103 6.82155533,18.416731 7.03486751,18.8640179 C6.70577369,18.9530495 6.35898976,19 6.00123996,19 C3.79141615,19 2,17.2085839 2,14.99876 L2,12.25 C2,11.059136 2.92516159,10.0843551 4.09595119,10.0051908 L4.25,10 L7.40645343,10.000271 Z M19.75,10 C20.9926407,10 22,11.0073593 22,12.25 L22.0008195,12.8103588 C20.8328473,11.6891263 19.2469007,11 17.5,11 L17.2548102,11.004539 L17.2548102,11.004539 C17.1009792,10.6291473 16.8766656,10.2891588 16.5994986,10.000271 L19.75,10 Z M18.5,4 C19.8807119,4 21,5.11928813 21,6.5 C21,7.88071187 19.8807119,9 18.5,9 C17.1192881,9 16,7.88071187 16,6.5 C16,5.11928813 17.1192881,4 18.5,4 Z M12,3 C13.6568542,3 15,4.34314575 15,6 C15,7.65685425 13.6568542,9 12,9 C10.3431458,9 9,7.65685425 9,6 C9,4.34314575 10.3431458,3 12,3 Z M5.5,4 C6.88071187,4 8,5.11928813 8,6.5 C8,7.88071187 6.88071187,9 5.5,9 C4.11928813,9 3,7.88071187 3,6.5 C3,5.11928813 4.11928813,4 5.5,4 Z M18.5,5.5 C17.9477153,5.5 17.5,5.94771525 17.5,6.5 C17.5,7.05228475 17.9477153,7.5 18.5,7.5 C19.0522847,7.5 19.5,7.05228475 19.5,6.5 C19.5,5.94771525 19.0522847,5.5 18.5,5.5 Z M12,4.5 C11.1715729,4.5 10.5,5.17157288 10.5,6 C10.5,6.82842712 11.1715729,7.5 12,7.5 C12.8284271,7.5 13.5,6.82842712 13.5,6 C13.5,5.17157288 12.8284271,4.5 12,4.5 Z M5.5,5.5 C4.94771525,5.5 4.5,5.94771525 4.5,6.5 C4.5,7.05228475 4.94771525,7.5 5.5,7.5 C6.05228475,7.5 6.5,7.05228475 6.5,6.5 C6.5,5.94771525 6.05228475,5.5 5.5,5.5 Z"
                id="🎨-Color"
              ></path>
            </g>
          </g>
        </svg>
      </div>
      <div class="text-center lg:text-2xl text-xl font-bold text-gray-800 w-2/3">
        Join the community 👥
        <br />
        <br />
        Fill out a form and pay your registration
        <span class="font-extrabold text-purple-500 cursor-pointer" @click="messageFee"> fee</span>.
      </div>
    </div>
    <div class="flex flex-col items-center justify-center gap-y-8 mt-12">
      <div class="w-1/3">
        <img src="others/characters/Miss.svg" alt="Miss" class="rounded-2xl" />
      </div>
      <div class="text-center lg:text-2xl text-xl font-bold text-gray-800 w-2/3">
        Mint your avatar 🎨
        <br />
        <br />
        Receive your avatar in your wallet immediately.
      </div>
    </div>
    <div class="flex flex-col items-center justify-center gap-y-8 mt-12">
      <div class="w-1/3">
        <img src="others/icons/engage.svg" alt="Engage" />
      </div>
      <div class="text-center lg:text-2xl text-xl font-bold text-gray-800 w-2/3">
        Play and
        <a href="https://www.dfinitycommunity.com/why-icp-squad-nfts-are-game-changer-for-internet-computer-dapps/" target="_blank" class="text-purple-500 font-extrabold"> earn 💰 </a> (soon)
        <br />
        <br />
        Missions, contests , partnerships and more !
        <span class="font-extrabold text-purple-500 cursor-pointer" @click="messageDev"> * </span>
      </div>
    </div>
    <div class="w-full md:col-span-3 flex-1 bg-gradient-to-l from-gray-600 via-gray-900 to-black 2xl:text-5xl lg:text-4xl md:text-3xl text-2xl font-semibold text-white">
      <h1 class="text-center mt-12">Connect your wallet.</h1>

      <div class="flex flex-row justify-around mb-12">
        <button class="lg:text-3xl md:text-2xl text-xl shadow-2xl font-marker text-white bg-pink-600 rounded py-6 px-8 mt-8 cursor-pointer hidden md:block" @click="plug">Plug</button>
        <button class="lg:text-3xl md:text-2xl text-xl shadow-2xl font-marker text-white bg-pink-600 rounded py-6 px-8 mt-8 cursor-pointer" @click="stoic">Stoic</button>
      </div>
    </div>
  </div>
  <!-- Wallet -->
</template>

<script lang="ts">
import { defineComponent } from "vue";
import { useStore } from "vuex";
import { HUB_CANISTER_ID, HOST } from "../../utils/const";
import { idlFactory as idlFactory_hub } from "declarations/hub/index";
import idlFactory_ledger from "interfaces/ledger/ledger.did.js";
//@ts-ignore
import { StoicIdentity } from "ic-stoic-identity";
import { HttpAgent, Actor } from "@dfinity/agent";
import { createLedgerCanister, LEDGER_CANISTER_ID } from "../../utils/ledger";

export default defineComponent({
  setup() {
    const store = useStore();
    const messageFee = () => {
      alert(
        "During your registration, you will be charged a fee of 1 ICP.\nInstead of selling our NFTs on a marketplace we choosed this method of funding, in accordance with our inclusive gameplay. \nThis money will be put to good use to pay our artists, developers and fund the future of ICP Squad. \n\nThank you for your support!"
      );
    };
    const messageDev = () => {
      alert("Concept still in development, please stay tuned!");
    };

    //  Plug
    const whitelist = [HUB_CANISTER_ID, LEDGER_CANISTER_ID];
    const plug = async () => {
      const result = await (window as any).ic?.plug?.requestConnect({
        whitelist,
        HOST,
      });
      if (!result) {
        return;
      }
      store.commit("setWallet", "Plug");
      let principal = await (window as any).ic?.plug?.agent.getPrincipal();
      store.commit("setPrincipal", principal);
      //@ts-ignore
      const actor_ledger = await window.ic.plug.createActor({
        canisterId: LEDGER_CANISTER_ID,
        interfaceFactory: idlFactory_ledger,
      });
      store.commit("setAuthenticatedActor_ledger", actor_ledger);
      //@ts-ignore
      const actor_hub = await window.ic.plug.createActor({
        canisterId: HUB_CANISTER_ID,
        interfaceFactory: idlFactory_hub,
      });
      store.commit("setAuthenticatedActor_hub", actor_hub);
    };

    //  Stoic
    let ledgerActor: any;
    const stoic = async () => {
      try {
        StoicIdentity.load().then(async (identity: any) => {
          if (identity !== false) {
            //ID is a already connected wallet!
          } else {
            //No existing connection, lets make one!
            identity = await StoicIdentity.connect();
          }
          try {
            await identity.sign("a");
          } catch (e) {
            alert("Error logging in with stoic, please ensure cookies are enabled");
            return;
          }
          //Lets display the connected principal!
          console.log(identity.getPrincipal().toText());
          let principal = identity.getPrincipal();
          store.commit("setWallet", "Stoic");
          store.commit("setPrincipal", principal);

          //Create an actor canister
          const actor = Actor.createActor(idlFactory_hub, {
            agent: new HttpAgent({
              identity,
            }),
            canisterId: HUB_CANISTER_ID,
          });
          store.commit("setAuthenticatedActor_hub", actor);
          ledgerActor = createLedgerCanister(new HttpAgent({ identity }));
          store.commit("setAuthenticatedActor_ledger", ledgerActor);
        });
      } catch (e) {
        alert(e);
        return;
      }
    };

    return {
      messageFee,
      messageDev,
      plug,
      stoic,
    };
  },
});
</script>
